(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{746:function(s,e,a){"use strict";a.r(e);var n=a(5),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"redis主从缩容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis主从缩容"}},[s._v("#")]),s._v(" redis主从缩容")]),s._v(" "),a("p",[s._v("[toc]")]),s._v(" "),a("p",[a("strong",[s._v("当流量高峰过去后我们就需要缩容了，删除7号和8号，恢复到3主3从")])]),s._v(" "),a("blockquote",[a("p",[s._v("我们需要原路返回嘛？又或者我们先删除6387还是先删除6388")])]),s._v(" "),a("p",[a("strong",[s._v("我们只能先删从机8号，因为master是负责写的，清出来的槽号重新分配，再删除7号")])]),s._v(" "),a("h3",{attrs:{id:"检查集群状态获取8号机器noid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查集群状态获取8号机器noid"}},[s._v("#")]),s._v(" 检查集群状态获取8号机器noid")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("redis-cli --cluster check 192.168.121.129:6387\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"删除8号机器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除8号机器"}},[s._v("#")]),s._v(" 删除8号机器")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("ip：从机端口")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("id：从机6388结点id")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("redis-cli --cluster del-node ip:端口 id\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("实现")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("root@ubuntu:/data# redis-cli --cluster del-node 192.168.121.129:6388 b1e31c7e33bf32bf880c8dd8a3c45053381acee3\n>>> Removing node b1e31c7e33bf32bf880c8dd8a3c45053381acee3 from cluster 192.168.121.129:6388\n>>> Sending CLUSTER FORGET messages to the cluster...\n>>> Sending CLUSTER RESET SOFT to the deleted node.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("此时8号被干掉了，我们继续清空槽号")])]),s._v(" "),a("h3",{attrs:{id:"清空槽号并且分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#清空槽号并且分配"}},[s._v("#")]),s._v(" 清空槽号并且分配")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("redis-cli --cluster reshard 192.168.121.129:6381 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",[a("li",[a("p",[a("strong",[s._v("此时我们需要将其除以四")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("先填入iD是1号结点的id")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("再填入的是7号将要删除结点id")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("最后填入的是node")])])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2022/05/12/tPyVcjvnbfq5gmz.png",alt:"image-20220512212110632"}})]),s._v(" "),a("p",[a("strong",[s._v("可以看到1号结点占有的槽位两倍，7号没有槽位")])]),s._v(" "),a("h3",{attrs:{id:"删除7号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除7号"}},[s._v("#")]),s._v(" 删除7号")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("redis-cli --cluster del-node ip:端口 id\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2022/05/12/7hiMYy4PnVQE1wB.png",alt:"image-20220512212310546"}})]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("root@ubuntu:/data# redis-cli --cluster del-node 192.168.121.129:6387 d731228e31d4918a2b30225fa6722eb7cd077340\n>>> Removing node d731228e31d4918a2b30225fa6722eb7cd077340 from cluster 192.168.121.129:6387\n>>> Sending CLUSTER FORGET messages to the cluster...\n>>> Sending CLUSTER RESET SOFT to the deleted node.\nroot@ubuntu:/data# redis-cli --cluster check 192.168.121.129:6381 \n192.168.121.129:6381 (96404384...) -> 3 keys | 8192 slots | 1 slaves.\n192.168.121.129:6382 (cc788412...) -> 1 keys | 4096 slots | 1 slaves.\n192.168.121.129:6383 (447dba4f...) -> 2 keys | 4096 slots | 1 slaves.\n[OK] 6 keys in 3 masters.\n0.00 keys per slot on average.\n>>> Performing Cluster Check (using node 192.168.121.129:6381)\nM: 964043841e4c5519d3cde93cae6b32ebe5ba1830 192.168.121.129:6381\n   slots:[0-6826],[10923-12287] (8192 slots) master\n   1 additional replica(s)\nS: 125e88db573553be475175cd604eb9887506a121 192.168.121.129:6385\n   slots: (0 slots) slave\n   replicates cc788412e2b72c5a3ea3ba5cd9c80197a554382f\nS: 187c17cec8177135b6203328156bb7a7e73714d0 192.168.121.129:6384\n   slots: (0 slots) slave\n   replicates 964043841e4c5519d3cde93cae6b32ebe5ba1830\nM: cc788412e2b72c5a3ea3ba5cd9c80197a554382f 192.168.121.129:6382\n   slots:[6827-10922] (4096 slots) master\n   1 additional replica(s)\nM: 447dba4f4813f9178d67e62488a4c4c5aba87635 192.168.121.129:6383\n   slots:[12288-16383] (4096 slots) master\n   1 additional replica(s)\nS: 702a95b6eeb02a9d01d38152d599fdf57c70cf0c 192.168.121.129:6386\n   slots: (0 slots) slave\n   replicates 447dba4f4813f9178d67e62488a4c4c5aba87635\n[OK] All nodes agree about slots configuration.\n>>> Check for open slots...\n>>> Check slots coverage...\n[OK] All 16384 slots covered.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[a("strong",[s._v("此时大功告成！！！")])])])}),[],!1,null,null,null);e.default=t.exports}}]);